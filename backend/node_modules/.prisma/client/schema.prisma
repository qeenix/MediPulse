// backend/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./clinic.db"
}

// --- ENUMS ---

enum UserRole {
  ADMIN
  DOCTOR
  PHARMACIST
}

enum PrescriptionStatus {
  PENDING
  DISPENSED
  CANCELLED
}

enum DosageCategory {
  TABLET
  CAPSULE
  SYRUP_LIQUID
  INJECTION
  CREAM_OINTMENT_GEL
  DROPS
  INHALER
  SUPPOSITORY
  POWDER
}

// --- MODELS ---

model User {
  id       String   @id @default(uuid())
  username String   @unique
  password String
  name     String
  role     UserRole

  // Relations
  consultations          Consultation[]
  dispensedPrescriptions Prescription[] @relation("DispensedBy")
}

model Patient {
  id              String         @id @default(uuid())
  mobileNumber    String         @unique
  name            String
  currentWeightKg Float?
  consultations   Consultation[]
}

model Consultation {
  id String @id @default(uuid())

  patient   Patient @relation(fields: [patientId], references: [id])
  patientId String

  doctor   User   @relation(fields: [doctorId], references: [id])
  doctorId String

  createdAt DateTime @default(now())

  diagnosis            String?
  notes                String?
  weightAtConsultation Float?
  attachments          String? // JSON string of file paths

  prescription Prescription?
}

model Prescription {
  id             String       @id @default(uuid())
  consultation   Consultation @relation(fields: [consultationId], references: [id])
  consultationId String       @unique

  status PrescriptionStatus @default(PENDING)

  dispensedAt DateTime?

  // Relation to the Pharmacist who dispensed it
  dispensedByPharmacist User?   @relation("DispensedBy", fields: [dispensedByUserId], references: [id])
  dispensedByUserId     String?

  prescribedDrugs PrescribedDrug[]

  // ✅ NEW: Relation to the Bill (Fixes Income Calculation)
  bill PharmacyBill?
}

model Drug {
  id           String           @id @default(uuid())
  name         String           @unique
  dosageForm   DosageCategory
  stockItems   StockItem[]
  prescribedIn PrescribedDrug[]
}

model StockItem {
  id              String    @id @default(uuid())
  drug            Drug      @relation(fields: [drugId], references: [id])
  drugId          String
  batchNumber     String?
  expiryDate      DateTime
  quantityInStock Int
  purchasePrice   Float
  sellingPrice    Float
  supplier        Supplier? @relation(fields: [supplierId], references: [id])
  supplierId      String?
}

model PrescribedDrug {
  id             String       @id @default(uuid())
  prescription   Prescription @relation(fields: [prescriptionId], references: [id])
  prescriptionId String
  drug           Drug         @relation(fields: [drugId], references: [id])
  drugId         String
  dosage         String
  quantity       Int
}

model Supplier {
  id          String      @id @default(uuid())
  name        String      @unique
  contactInfo String?
  stockItems  StockItem[]
}

// ✅ NEW MODEL: Pharmacy Bill (Required for Income Tab)
model PharmacyBill {
  id             String       @id @default(uuid())
  prescription   Prescription @relation(fields: [prescriptionId], references: [id])
  prescriptionId String       @unique
  totalAmount    Float
  issuedAt       DateTime     @default(now())
}
